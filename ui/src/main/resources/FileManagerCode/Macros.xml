<?xml version="1.0" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This is free software; you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as
 * published by the Free Software Foundation; either version 2.1 of
 * the License, or (at your option) any later version.
 *
 * This software is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this software; if not, write to the Free
 * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
 * 02110-1301 USA, or see the FSF site: http://www.fsf.org.
-->

<xwikidoc version="1.1">
  <web>FileManagerCode</web>
  <name>Macros</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <creationDate>1401201952000</creationDate>
  <parent>FileManagerCode.WebHome</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <date>1401280487000</date>
  <contentUpdateDate>1401280300000</contentUpdateDate>
  <version>1.1</version>
  <title/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content>{{velocity output=false}}
#set ($isAjaxRequest = $request.getHeader('X-Requested-With') == 'XMLHttpRequest')
#set ($selectChildFolders = 'from doc.object(FileManagerCode.FolderClass) as folder where doc.space = :space and doc.parent = :parent')

#macro (getChildFolders $parentDoc $return)
  #getFolders($selectChildFolders {'space': $parentDoc.space, 'parent': $parentDoc.fullName} $_return)
  #set ($return = $NULL)
  #setVariable("$return" $_return)
#end

#macro (getFolders $statement $parameters $return)
  #set ($query = $services.query.xwql("$statement order by doc.name"))
  #set ($countQuery = $services.query.xwql($statement).addFilter('count'))
  #foreach ($entry in $parameters.entrySet())
    #set ($discard = $query.bindValue($entry.key, $entry.value))
    #set ($discard = $countQuery.bindValue($entry.key, $entry.value))
  #end
  #set ($folderCount = $countQuery.execute().get(0))
  #set ($folders = [])
  #set ($offset = $mathtool.toInteger($request.offset))
  #if ($offset)
    #set ($discard = $query.setOffset($offset))
  #end
  #set ($limit = $mathtool.toInteger($request.limit))
  #if ($limit)
    #set ($discard = $query.setLimit($limit))
  #end
  #foreach ($folderId in $query.execute())
    #set ($folderDoc = $xwiki.getDocument($folderId))
    #getFolder($folderDoc $folder)
    #set ($discard = $folders.add($folder))
  #end
  #set ($return = $NULL)
  #setVariable("$return" {
    'totalCount': $folderCount,
    'offset': $offset,
    'limit': $limit,
    'list': $folders
  })
#end

#macro (getFolder $folderDoc $return)
  #set ($path = [])
  #getPath($folderDoc $path)
  #if (!$path.isEmpty())
    #set ($path = $path.subList(1, $path.size()))
  #end
  #set ($return = $NULL)
  #setVariable("$return" {
    'id': $folderDoc.name,
    'name': $folderDoc.plainTitle,
    'path': $path
  })
#end

#macro (createFolder $name $parent)
  #if ("$!name" == '')
    #set ($name = 'Untitled Folder')
  #end
  #getUniquePageName($name $id)
  #set ($folderReference = $services.model.createDocumentReference($doc.wiki, $doc.space, $id))
  #if ("$!parent" == '')
    #set ($parent = $doc.name)
  #end
  #set ($parentReference = $services.model.createDocumentReference($doc.wiki, $doc.space, $parent))
  $response.sendRedirect($xwiki.getURL($folderReference, 'save', $escapetool.url({
    'title': $name,
    'parent': $services.model.serialize($parentReference, 'compactwiki'),
    'template': 'FileManagerCode.FolderTemplate',
    'comment': 'Folder created',
    'form_token': $request.form_token,
    'xredirect': $xwiki.getURL($folderReference, 'get', 'outputSyntax=plain')
  })))
#end

#macro (getFilesStatement $where $return)
  #set ($from = 'from doc.object(FileManagerCode.FileClass) as file')
  #set ($orderBy = '')
  #set ($sortMap = {
    'name': 'attach.filename',
    'size': 'attach.filesize',
    'date': 'doc.date',
    'author': 'doc.author'
  })
  #set ($sort = $sortMap.get($request.sort))
  #if ($sort)
    #if ($sort.startsWith('attach.'))
      ## We need to join with the Attachments table.
      #set ($from = "$from, XWikiAttachment attach")
      #set ($where = "$!where and attach.docId = doc.id")
    #end
    #set ($order = $request.order)
    #if ($order != 'desc')
      #set ($order = '')
    #end
    #set ($orderBy = "order by $sort $order")
  #end
  #if ("$!where" != '')
    #set ($where = "where $stringtool.removeStart($where.trim(), 'and')")
  #end
  #set ($return = $NULL)
  #setVariable("$return" "$from $!where $orderBy")
#end

#macro (getFiles $statement $parameters $return)
  #set ($query = $services.query.xwql($statement))
  #set ($countQuery = $services.query.xwql($statement).addFilter('count'))
  #foreach ($entry in $parameters.entrySet())
    #set ($discard = $query.bindValue($entry.key, $entry.value))
    #set ($discard = $countQuery.bindValue($entry.key, $entry.value))
  #end
  #set ($fileCount = $countQuery.execute().get(0))
  #set ($files = [])
  #set ($offset = $mathtool.toInteger($request.offset))
  #if ($offset)
    #set ($discard = $query.setOffset($offset))
  #end
  #set ($limit = $mathtool.toInteger($request.limit))
  #if ($limit)
    #set ($discard = $query.setLimit($limit))
  #end
  #foreach ($fileId in $query.execute())
    #set ($fileDoc = $xwiki.getDocument($fileId))
    #getFile($fileDoc $file)
    #set ($discard = $files.add($file))
  #end
  #set ($return = $NULL)
  #setVariable("$return" {
    'totalCount': $fileCount,
    'offset': $offset,
    'limit': $limit,
    'list': $files
  })
#end

#macro (getFile $fileDoc $return)
  #getFilePaths($fileDoc $paths)
  #set ($attachments = $fileDoc.attachmentList)
  #if ($attachments.size() &gt; 0)
    #set ($attach = $attachments.get(0))
  #else
    ## Fail safe.
    #set ($attach = {
      'filename': $fileDoc.plainTitle,
      'filesize': 0
    })
  #end
  #set ($return = $NULL)
  #setVariable("$return" {
    'id': $fileDoc.name,
    'name': $attach.filename,
    'date': $fileDoc.date,
    'author': $fileDoc.author,
    'size': $attach.filesize,
    'mediaType': $attach.mimeType,
    'version': $fileDoc.version,
    'description': $fileDoc.display('description'),
    'paths': $paths
  })
#end

#macro (getFilePaths $fileDoc $return)
  #set ($tags = $fileDoc.getObject('XWiki.TagClass').getProperty('tags').value)
  #set ($_paths = [])
  #if ($tags &amp;&amp; $tags.size() &gt; 0)
    #set ($docNameInTags = [])
    #foreach ($tag in $tags)
      #set ($discard = $docNameInTags.add("doc.name = ?$foreach.count"))
    #end
    #set ($docNameInTags = $stringtool.join($docNameInTags, ' or '))
    #set ($statement = "from doc.object(FileManagerCode.FolderClass) as folder where $docNameInTags")
    #foreach ($folderId in $services.query.xwql($statement).bindValues($tags).execute())
      #set ($folderReference = $services.model.resolveDocument($folderId, 'explicit', $fileDoc.documentReference))
      #set ($folderDoc = $xwiki.getDocument($folderReference))
      #set ($path = [])
      #getPath($folderDoc $path)
      #if (!$path.isEmpty())
        #set ($discard = $_paths.add($path))
      #end
    #end
  #end
  #set ($return = $NULL)
  #setVariable("$return" $_paths)
#end

#macro (getPath $folderDoc $path)
  ## Prevent cycles. Also make sure the given document is a folder.
  #if ($folderDoc &amp;&amp; !$folderDoc.isNew() &amp;&amp; !$path.contains($folderDoc.name)
      &amp;&amp; $folderDoc.getObject('FileManagerCode.FolderClass'))
    #set ($discard = $path.add($folderDoc.name))
    #if ("$!folderDoc.parent" != '')
      #set ($parentReference = $services.model.resolveDocument($folderDoc.parent, 'explicit', $folderDoc.documentReference))
      ## The parent must be on the same drive (space).
      #if ($folderDoc.documentReference.parent.equals($parentReference.parent))
        #getPath($xwiki.getDocument($parentReference) $path)
      #end
    #end
  #end
#end

## TODO: Use the script service to avoid duplicated code!
#macro (getUniquePageName $name $return)
  #set ($documentReference = $services.model.createDocumentReference($doc.wiki, $doc.space, $name))
  #if (!$xwiki.exists($documentReference))
    #set ($uniqueName = $name)
  #else
    #set ($found = false)
    #foreach ($counter in [1..99])
      #set ($uniqueName = "$name$counter")
      #set ($documentReference = $services.model.createDocumentReference($doc.wiki, $doc.space, $uniqueName))
      #if (!$xwiki.exists($documentReference))
        #set ($found = true)
        #break
      #end
    #end
    #if (!$found)
      #set ($uniqueName = "$name$mathtool.random(100, 1000)")
    #end
  #end
  #set ($return = $NULL)
  #setVariable("$return" $uniqueName)
#end

#macro (getDriveReference $return)
  #set ($statement = 'from doc.object(FileManagerCode.DriveClass) as drive where doc.space = :space')
  #set ($drives = $services.query.xwql($statement).bindValue('space', $doc.space).setLimit(1).execute())
  #if ($drives &amp;&amp; !$drives.isEmpty())
    #set ($driveReference = $services.model.resolveDocument($drives.get(0), 'explicit', $doc.documentReference))
  #else
    ## Fall-back on the space home page.
    #set ($driveReference = $services.model.createDocumentReference($doc.wiki, $doc.space, 'WebHome'))
  #end
  #set ($return = $NULL)
  #setVariable("$return" $driveReference)
#end

#macro (handleJobStartFailure $jobId)
  #if ($jobId)
    #getDriveReference($driveReference)
    #set ($discard = $response.sendRedirect($xwiki.getURL($driveReference, 'get', $escapetool.url({
      'outputSyntax': 'plain',
      'data': 'jobStatus',
      'id': $jobId
    }))))
  #else
    $response.sendError(500, $services.drive.lastError.message);
  #end
#end

#macro (getActiveJobs $return)
  #set ($activeJobs = [])
  #foreach ($jobId in $services.drive.activeJobs)
    #getJobStatus($jobId $jobStatus)
    #set ($discard = $activeJobs.add($jobStatus))
  #end
  #set ($return = $NULL)
  #setVariable("$return" $activeJobs)
#end

#macro (getJobStatus $jobId $return)
  #set ($jobStatus = $services.drive.getJobStatus($jobId))
  #if ($jobStatus)
    #set ($pathsAsJSON = [])
    #foreach ($path in $jobStatus.request.paths)
      #set ($discard = $pathsAsJSON.add({
        'parent': $path.folderReference.name,
        'child': $path.fileReference.name
      }))
    #end
    #set ($jobStatusAsJSON = {
      'id': $jobId,
      'state': $jobStatus.state,
      'request': {
        'type': $jobStatus.request.getProperty('job.type'),
        'user': "$jobStatus.request.getProperty('user.reference')",
        'paths': $pathsAsJSON
      },
      'log': {},
      'progress': {
        'offset': $jobStatus.progress.offset,
        'currentLevelOffset': $jobStatus.progress.currentLevelOffset
      },
      'startDate': $jobStatus.startDate,
      'endDate': $jobStatus.endDate
    })
    #if ($jobStatus.question)
      #set ($jobStatusAsJSON.question = {
        'source': $jobStatus.question.source.name,
        'destination': $jobStatus.question.destination.name
      })
    #end
    #if ($jobStatus.request.destination)
      #set ($jobStatusAsJSON.request.destination = {
        'parent': $jobStatus.request.destination.folderReference.name,
        'child': $jobStatus.request.destination.fileReference.name
      })
    #end
    #set ($return = $NULL)
    #setVariable("$return" $jobStatusAsJSON)
  #end
#end
{{/velocity}}</content>
</xwikidoc>
